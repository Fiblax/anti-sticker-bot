import os
import json
from telegram import Update, ChatMember
from telegram.ext import (
    ApplicationBuilder, MessageHandler, CommandHandler,
    filters, ContextTypes
)

BLOCKED_FILE = "blocked.json"

def load_blocked():
    if not os.path.exists(BLOCKED_FILE):
        return []
    with open(BLOCKED_FILE, "r") as f:
        return json.load(f)

def save_blocked(blocked_packs):
    with open(BLOCKED_FILE, "w") as f:
        json.dump(blocked_packs, f)

async def is_user_admin(update: Update, user_id: int):
    member = await update.effective_chat.get_member(user_id)
    return member.status in [ChatMember.ADMINISTRATOR, ChatMember.OWNER]

async def handle_sticker(update: Update, context: ContextTypes.DEFAULT_TYPE):
    sticker = update.message.sticker
    blocked_packs = load_blocked()
    if sticker.set_name and sticker.set_name in blocked_packs:
        await update.message.delete()

async def block_sticker(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_user_admin(update, update.effective_user.id):
        await update.message.reply_text("â›” ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†Ù† Ø§Ø² Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ù†.")
        return

    if not context.args:
        await update.message.reply_text("Ø§Ø³ØªÙØ§Ø¯Ù‡: /blocksticker Ù†Ø§Ù…_Ù¾Ú©_Ø§Ø³ØªÛŒÚ©Ø±")
        return

    pack_name = context.args[0]
    blocked_packs = load_blocked()
    if pack_name not in blocked_packs:
        blocked_packs.append(pack_name)
        save_blocked(blocked_packs)
        await update.message.reply_text(f"âœ… Ù¾Ú© {pack_name} Ø¨Ù‡ Ù„ÛŒØ³Øª Ø¨Ù„Ø§Ú© Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.", parse_mode="Markdown")
    else:
        await update.message.reply_text("Ø§ÛŒÙ† Ù¾Ú© Ù‚Ø¨Ù„Ø§Ù‹ ØªÙˆÛŒ Ù„ÛŒØ³Øª Ø¨Ù„Ø§Ú© Ø¨ÙˆØ¯Ù‡.")

async def list_blocked(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_user_admin(update, update.effective_user.id):
        await update.message.reply_text("â›” ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†Ù† Ø§ÛŒÙ† Ù„ÛŒØ³Øª Ø±Ùˆ Ø¨Ø¨ÛŒÙ†Ù†.")
        return

    blocked_packs = load_blocked()
    if not blocked_packs:
        await update.message.reply_text("âŒ Ù‡ÛŒÚ† Ù¾Ú©ÛŒ Ø¨Ù„Ø§Ú© Ù†Ø´Ø¯Ù‡.")
    else:
        text = "ğŸ“› Ù¾Ú©â€ŒÙ‡Ø§ÛŒ Ø¨Ù„Ø§Ú©â€ŒØ´Ø¯Ù‡:\n" + "\n".join(f"â€¢ {p}" for p in blocked_packs)
        await update.message.reply_text(text, parse_mode="Markdown")

if name == "main":
    token = os.getenv("BOT_TOKEN")
    app = ApplicationBuilder().token(token).build()

    app.add_handler(MessageHandler(filters.Sticker.ALL, handle_sticker))
    app.add_handler(CommandHandler("blocksticker", block_sticker))
    app.add_handler(CommandHandler("listblocked", list_blocked))

    app.run_polling()
